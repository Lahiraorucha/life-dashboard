<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Dashboard</title>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --text-primary: #ffffff;
            --text-muted: #888888;
            --accent-1: #ff6b6b;
            --accent-2: #48dbfb;
            --accent-3: #feca57;
            --accent-4: #10b981;
            --accent-5: #a855f7;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding-bottom: 70px;
        }
        .nav {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            padding: 15px 20px; background: rgba(0,0,0,0.3);
            position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
        }
        .nav-btn {
            padding: 10px 25px; border: none; border-radius: 25px; cursor: pointer;
            font-size: 0.95rem; transition: all 0.3s;
            background: rgba(255,255,255,0.1); color: #fff;
        }
        .nav-btn.active {
            background: linear-gradient(90deg, var(--accent-3), var(--accent-1));
            color: var(--bg-secondary); font-weight: bold;
        }
        .nav-btn.settings { background: rgba(255,255,255,0.05); padding: 10px 15px; }
        .add-task-btn {
            padding: 10px 20px; border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 25px; cursor: pointer; font-size: 0.9rem;
            background: transparent; color: var(--accent-3); margin-left: 15px;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--accent-1), var(--accent-3), var(--accent-2));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header-sub { color: var(--text-muted); font-size: 0.9rem; margin-top: 5px; }
        .countdowns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        @media (max-width: 800px) { .countdowns { grid-template-columns: repeat(2, 1fr); } }
        .countdown-card {
            background: rgba(255,255,255,0.06); border-radius: 10px;
            padding: 12px; text-align: center; border-left: 3px solid;
        }
        .countdown-number { font-size: 1.6rem; font-weight: bold; }
        .countdown-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        .view { display: none; }
        .view.active { display: block; }
        .today-grid { display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 900px) { .today-grid { grid-template-columns: 1fr; } }
        .card {
            background: rgba(255,255,255,0.05); border-radius: 12px;
            padding: 16px; border: 1px solid rgba(255,255,255,0.08);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-header h2 { font-size: 1rem; color: #ddd; }
        .card-header-btn {
            padding: 5px 12px; background: rgba(254,202,87,0.2); border: none;
            border-radius: 15px; color: var(--accent-3); font-size: 0.8rem; cursor: pointer;
        }
        .task-list { min-height: 150px; }
        .task-item {
            display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
            border-radius: 10px; background: rgba(255,255,255,0.04);
            cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent;
        }
        .task-item:hover { background: rgba(255,255,255,0.08); }
        .task-item.completed { opacity: 0.5; }
        .task-item.completed .task-title { text-decoration: line-through; }
        .task-item.template { opacity: 0.4; border-style: dashed; }
        .task-checkbox {
            width: 22px; height: 22px; border-radius: 6px; border: 2px solid #444;
            margin-right: 12px; display: flex; align-items: center;
            justify-content: center; flex-shrink: 0;
        }
        .task-item.completed .task-checkbox { background: var(--accent-4); border-color: var(--accent-4); }
        .task-checkbox-inner { color: white; opacity: 0; font-size: 14px; }
        .task-item.completed .task-checkbox-inner { opacity: 1; }
        .task-content { flex: 1; }
        .task-title { font-weight: 500; font-size: 0.95rem; }
        .task-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        .task-delete {
            width: 24px; height: 24px; border-radius: 6px; border: none;
            background: rgba(239,68,68,0.2); color: #ef4444; cursor: pointer;
            opacity: 0; transition: opacity 0.2s; font-size: 14px;
        }
        .task-item:hover .task-delete { opacity: 1; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        @media (max-width: 1000px) { .week-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .week-grid { grid-template-columns: 1fr 1fr; } }
        .day-column { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 10px; min-height: 280px; }
        .day-column.today { border: 2px solid rgba(254,202,87,0.5); }
        .day-header { text-align: center; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px; }
        .day-name { font-weight: bold; font-size: 0.85rem; }
        .day-date { font-size: 0.7rem; color: var(--text-muted); }
        .day-progress { height: 3px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 5px; }
        .day-progress-fill { height: 100%; background: var(--accent-4); border-radius: 3px; }
        .week-task {
            padding: 8px; margin-bottom: 6px; border-radius: 6px; font-size: 0.75rem;
            cursor: pointer; border-left: 3px solid; transition: all 0.2s;
        }
        .week-task:hover { transform: scale(1.02); }
        .week-task.template { opacity: 0.4; border-style: dashed; }
        .week-task.completed { opacity: 0.4; text-decoration: line-through; }
        .week-task-time { font-size: 0.65rem; color: rgba(255,255,255,0.5); margin-top: 2px; }
        .cat-1 { border-color: var(--accent-1); }
        .cat-2 { border-color: var(--accent-2); }
        .cat-3 { border-color: var(--accent-3); }
        .cat-4 { border-color: var(--accent-4); }
        .cat-5 { border-color: var(--accent-5); }
        .week-task.cat-1 { background: rgba(255,107,107,0.15); }
        .week-task.cat-2 { background: rgba(72,219,251,0.15); }
        .week-task.cat-3 { background: rgba(254,202,87,0.15); }
        .week-task.cat-4 { background: rgba(16,185,129,0.15); }
        .week-task.cat-5 { background: rgba(168,85,247,0.15); }
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); z-index: 1000;
            align-items: center; justify-content: center; overflow-y: auto; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-secondary); border-radius: 16px; padding: 25px;
            width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1);
            max-height: 90vh; overflow-y: auto;
        }
        .modal.wide { max-width: 650px; }
        .modal h3 { margin-bottom: 15px; font-size: 1.2rem; }
        .modal p { color: var(--text-muted); margin-bottom: 15px; font-size: 0.9rem; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .form-group input, .form-group select {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05); color: #fff; font-size: 0.9rem;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 8px; border: none;
            cursor: pointer; font-size: 0.95rem; font-weight: 500;
        }
        .modal-btn.primary { background: linear-gradient(90deg, var(--accent-3), var(--accent-1)); color: var(--bg-secondary); }
        .modal-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .modal-btn.danger { background: rgba(239,68,68,0.2); color: #ef4444; }
        .setup-step { display: none; }
        .setup-step.active { display: block; }
        .setup-progress { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; }
        .setup-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.2); }
        .setup-dot.active { background: var(--accent-3); }
        .setup-dot.done { background: var(--accent-4); }
        .goal-input-group { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
        .template-day { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 10px; margin-bottom: 8px; }
        .template-day-header { font-weight: bold; margin-bottom: 8px; font-size: 0.85rem; }
        .template-row { display: flex; gap: 6px; margin-bottom: 6px; align-items: center; flex-wrap: wrap; }
        .template-row input, .template-row select {
            padding: 6px 8px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05); color: #fff; font-size: 0.8rem;
        }
        .template-row input[type="text"] { flex: 1; min-width: 100px; }
        .template-row input[type="time"] { width: 85px; }
        .template-row select { width: 90px; }
        .template-row button { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
        .btn-add { background: rgba(16,185,129,0.2); color: var(--accent-4); }
        .btn-remove { background: rgba(239,68,68,0.2); color: #ef4444; }
        .sidebar-card { margin-bottom: 15px; }
        .sidebar-card h3 { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .stat-box { background: rgba(255,255,255,0.03); border-radius: 8px; padding: 12px; text-align: center; }
        .stat-value { font-size: 1.4rem; font-weight: bold; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); }
        .mini-sug {
            padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;
            margin-bottom: 5px; font-size: 0.8rem; cursor: pointer;
            display: flex; justify-content: space-between; border-left: 2px solid var(--text-muted);
        }
        .mini-sug:hover { background: rgba(255,255,255,0.08); }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 6px; margin: 8px 0; }
        .progress-fill { height: 100%; border-radius: 6px; }
        .footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15,15,26,0.95); padding: 12px;
            display: flex; justify-content: center; gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .footer-btn { padding: 10px 20px; border-radius: 20px; border: none; cursor: pointer; font-size: 0.85rem; }
        .footer-btn.primary { background: linear-gradient(90deg, var(--accent-3), var(--accent-1)); color: var(--bg-secondary); font-weight: bold; }
        .footer-btn.secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .goals-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media (max-width: 800px) { .goals-grid { grid-template-columns: 1fr; } }
        .goal-card { padding: 20px; }
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .goal-title { font-weight: bold; }
        .goal-deadline { font-size: 0.8rem; color: var(--text-muted); }
        .legend { display: flex; gap: 12px; justify-content: center; margin-bottom: 12px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: var(--text-muted); }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
    </style>
</head>
<body>
    <nav class="nav" id="mainNav" style="display:none;">
        <button class="nav-btn active" id="btnToday">üìÖ Today</button>
        <button class="nav-btn" id="btnWeek">üìä Week</button>
        <button class="nav-btn" id="btnGoals">üéØ Goals</button>
        <button class="add-task-btn" id="btnAddTask">+ Add Task</button>
        <button class="nav-btn settings" id="btnSettings">‚öôÔ∏è</button>
    </nav>
    <div class="container">
        <div class="header">
            <h1>Life Dashboard</h1>
            <div class="header-sub" id="headerSub">Loading...</div>
        </div>
        <div class="countdowns" id="countdowns"></div>
        <div class="view active" id="todayView">
            <div class="today-grid">
                <div class="card">
                    <div class="card-header">
                        <h2>üìã Today's Tasks</h2>
                        <button class="card-header-btn" id="btnLoadTpl">+ Load Template</button>
                    </div>
                    <div class="task-list" id="todayTasks"></div>
                </div>
                <div>
                    <div class="card sidebar-card">
                        <div class="stats-row">
                            <div class="stat-box"><div class="stat-value" id="doneCount">0</div><div class="stat-label">Done</div></div>
                            <div class="stat-box"><div class="stat-value" id="leftCount">0</div><div class="stat-label">Left</div></div>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="dayProgress" style="width:0%;background:var(--accent-4);"></div></div>
                    </div>
                    <div class="card sidebar-card">
                        <h3>üí° Quick Add</h3>
                        <div id="suggestions"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="view" id="weekView">
            <div class="legend" id="legend"></div>
            <div class="week-grid" id="weekGrid"></div>
            <p style="text-align:center;color:var(--text-muted);font-size:0.75rem;margin-top:12px;">Faded = planned ‚Ä¢ Solid = active ‚Ä¢ Click to toggle</p>
        </div>
        <div class="view" id="goalsView">
            <div class="goals-grid" id="goalsGrid"></div>
        </div>
    </div>
    <div class="footer" id="mainFooter" style="display:none;">
        <button class="footer-btn secondary" id="btnUndo">‚Ü©Ô∏è Undo</button>
        <button class="footer-btn primary" id="btnEndDay">‚úÖ End Day</button>
    </div>

    <!-- SETUP WIZARD -->
    <div class="modal-overlay active" id="setupModal">
        <div class="modal wide">
            <div class="setup-progress" id="setupProgress"></div>
            <div class="setup-step active" id="step1">
                <h3>üëã Welcome to Life Dashboard!</h3>
                <p>Track your goals, manage your week, and build better habits. Let's set up your personal dashboard in 3 steps.</p>
                <p>Your data stays in your browser - nothing is sent anywhere.</p>
                <div class="modal-actions"><button class="modal-btn primary" onclick="nextStep()">Let's Go! ‚Üí</button></div>
            </div>
            <div class="setup-step" id="step2">
                <h3>üéØ What are your goals?</h3>
                <p>Add up to 4 major goals with optional deadlines.</p>
                <div id="goalsSetup"></div>
                <button class="modal-btn secondary" onclick="addGoal()" style="margin-top:8px;padding:8px 16px;">+ Add Goal</button>
                <div class="modal-actions">
                    <button class="modal-btn secondary" onclick="prevStep()">‚Üê Back</button>
                    <button class="modal-btn primary" onclick="nextStep()">Next ‚Üí</button>
                </div>
            </div>
            <div class="setup-step" id="step3">
                <h3>üìÖ Design your ideal week</h3>
                <p>Create a template for each day. These show as suggestions you can activate.</p>
                <div id="templateSetup" style="max-height:350px;overflow-y:auto;"></div>
                <div class="modal-actions">
                    <button class="modal-btn secondary" onclick="prevStep()">‚Üê Back</button>
                    <button class="modal-btn primary" onclick="finishSetup()">Finish ‚úì</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD TASK MODAL -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <h3>Add New Task</h3>
            <div class="form-group"><label>Task Name</label><input type="text" id="taskName" placeholder="What do you need to do?"></div>
            <div class="form-row">
                <div class="form-group"><label>Category</label><select id="taskCat"></select></div>
                <div class="form-group"><label>Time</label><input type="time" id="taskTime" value="09:00"></div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveTask()">Add Task</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>‚öôÔ∏è Settings</h3>
            <div class="modal-actions" style="flex-direction:column;">
                <button class="modal-btn secondary" onclick="editSetup()">Edit Goals & Schedule</button>
                <button class="modal-btn secondary" onclick="exportData()">Export Data</button>
                <button class="modal-btn secondary" onclick="importData()">Import Data</button>
                <button class="modal-btn danger" onclick="resetAll()">Reset Everything</button>
            </div>
            <div class="modal-actions"><button class="modal-btn secondary" onclick="closeSettings()">Close</button></div>
        </div>
    </div>

<script>
var CFG_KEY='lifeDashCfg',DATA_KEY='lifeDashData';
var cfg=null,data={},undo=[],step=1;
var defaultCats=[{id:'c1',name:'Fitness',emoji:'üèÉ'},{id:'c2',name:'Creative',emoji:'üé®'},{id:'c3',name:'Career',emoji:'üíº'},{id:'c4',name:'Projects',emoji:'üíª'},{id:'c5',name:'Other',emoji:'üìå'}];
var defaultCfg={goals:[],categories:defaultCats,template:{Mon:[],Tue:[],Wed:[],Thu:[],Fri:[],Sat:[],Sun:[]}};

function init(){
    loadCfg();loadData();
    if(!cfg||!cfg.goals||cfg.goals.length===0){showSetup();}
    else{hideSetup();renderAll();}
    setupEvents();
    setInterval(updateHeader,60000);
}
function loadCfg(){try{var s=localStorage.getItem(CFG_KEY);cfg=s?JSON.parse(s):null;}catch(e){cfg=null;}}
function saveCfg(){localStorage.setItem(CFG_KEY,JSON.stringify(cfg));}
function loadData(){try{var s=localStorage.getItem(DATA_KEY);data=s?JSON.parse(s):{};}catch(e){data={};}}
function saveData(){localStorage.setItem(DATA_KEY,JSON.stringify(data));}
function pushUndo(){undo.push(JSON.stringify(data));if(undo.length>20)undo.shift();}
function todayKey(){return new Date().toISOString().split('T')[0];}
function dayName(d){return['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][(d||new Date()).getDay()];}
function fmtTime(t){var p=t.split(':'),h=+p[0],m=p[1];return(h%12||12)+':'+m+(h>=12?' PM':' AM');}
function genId(){return'id_'+Date.now()+'_'+Math.random().toString(36).substr(2,6);}
function getDayData(k){if(!data[k])data[k]={tplStatus:{},custom:[]};return data[k];}
function catClass(id){if(!cfg||!cfg.categories)return'cat-5';var i=cfg.categories.findIndex(function(c){return c.id===id;});return'cat-'+((i>=0?i:4)+1);}

function showSetup(){document.getElementById('setupModal').classList.add('active');document.getElementById('mainNav').style.display='none';document.getElementById('mainFooter').style.display='none';step=1;renderStep();}
function hideSetup(){document.getElementById('setupModal').classList.remove('active');document.getElementById('mainNav').style.display='flex';document.getElementById('mainFooter').style.display='flex';}
function renderStep(){
    for(var i=1;i<=3;i++){document.getElementById('step'+i).classList.toggle('active',i===step);}
    var p='';for(var i=1;i<=3;i++){p+='<div class="setup-dot '+(i<step?'done':i===step?'active':'')+'"></div>';}
    document.getElementById('setupProgress').innerHTML=p;
    if(step===2)renderGoalsSetup();
    if(step===3)renderTemplateSetup();
}
function nextStep(){if(step===2)collectGoals();step++;renderStep();}
function prevStep(){step--;renderStep();}
function renderGoalsSetup(){
    var c=document.getElementById('goalsSetup');
    var g=(cfg&&cfg.goals)?cfg.goals:[{name:'',deadline:'',emoji:'üéØ'}];
    if(g.length===0)g=[{name:'',deadline:'',emoji:'üéØ'}];
    var h='';g.forEach(function(x,i){
        h+='<div class="goal-input-group"><div class="form-row"><div class="form-group"><label>Goal '+(i+1)+'</label><input type="text" class="g-name" value="'+(x.name||'')+'" placeholder="e.g., Run a marathon"></div><div class="form-group" style="width:70px;"><label>Emoji</label><input type="text" class="g-emoji" value="'+(x.emoji||'üéØ')+'" maxlength="2"></div></div><div class="form-group"><label>Deadline (optional)</label><input type="date" class="g-date" value="'+(x.deadline||'')+'"></div></div>';
    });c.innerHTML=h;
}
function addGoal(){if(!cfg)cfg=JSON.parse(JSON.stringify(defaultCfg));if(!cfg.goals)cfg.goals=[];if(cfg.goals.length>=4)return alert('Max 4 goals');collectGoals();cfg.goals.push({name:'',deadline:'',emoji:'üéØ'});renderGoalsSetup();}
function collectGoals(){if(!cfg)cfg=JSON.parse(JSON.stringify(defaultCfg));var gs=document.querySelectorAll('#goalsSetup .goal-input-group');cfg.goals=[];gs.forEach(function(g){var n=g.querySelector('.g-name').value.trim(),e=g.querySelector('.g-emoji').value.trim()||'üéØ',d=g.querySelector('.g-date').value;if(n)cfg.goals.push({name:n,emoji:e,deadline:d});});}
function renderTemplateSetup(){
    if(!cfg)cfg=JSON.parse(JSON.stringify(defaultCfg));
    if(!cfg.categories)cfg.categories=defaultCats;
    if(!cfg.template)cfg.template={Mon:[],Tue:[],Wed:[],Thu:[],Fri:[],Sat:[],Sun:[]};
    var c=document.getElementById('templateSetup');
    var days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    var opts='';cfg.categories.forEach(function(x){opts+='<option value="'+x.id+'">'+x.emoji+' '+x.name+'</option>';});
    var h='';days.forEach(function(day){
        var tasks=cfg.template[day]||[];
        h+='<div class="template-day" data-day="'+day+'"><div class="template-day-header">'+day+'</div><div class="tpl-tasks">';
        tasks.forEach(function(t){h+='<div class="template-row"><input type="time" class="t-time" value="'+t.time+'"><input type="text" class="t-title" value="'+t.title+'" placeholder="Task name"><select class="t-cat">'+opts.replace('value="'+t.cat+'"','value="'+t.cat+'" selected')+'</select><button class="btn-remove" onclick="this.parentElement.remove()">√ó</button></div>';});
        h+='</div><button class="btn-add" onclick="addTplTask(\''+day+'\')">+ Add</button></div>';
    });c.innerHTML=h;
}
function addTplTask(day){collectTemplate();if(!cfg.template[day])cfg.template[day]=[];cfg.template[day].push({time:'09:00',title:'',cat:'c1'});renderTemplateSetup();}
function collectTemplate(){if(!cfg)cfg=JSON.parse(JSON.stringify(defaultCfg));cfg.template={};document.querySelectorAll('.template-day').forEach(function(d){var day=d.dataset.day;cfg.template[day]=[];d.querySelectorAll('.template-row').forEach(function(r){var ti=r.querySelector('.t-time').value,tt=r.querySelector('.t-title').value.trim(),tc=r.querySelector('.t-cat').value;if(tt)cfg.template[day].push({time:ti,title:tt,cat:tc});});});}
function finishSetup(){collectTemplate();saveCfg();hideSetup();renderAll();}

function renderAll(){updateHeader();renderCountdowns();renderLegend();renderToday();renderWeek();renderGoals();}
function updateHeader(){var n=new Date(),ds=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],t=n.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}),d=n.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}),h=n.getHours(),gr=h<12?'Good morning':h<17?'Good afternoon':'Good evening';document.getElementById('headerSub').textContent=gr+'! '+ds[n.getDay()]+', '+d+' ‚Ä¢ '+t;}
function renderCountdowns(){var c=document.getElementById('countdowns');if(!cfg||!cfg.goals)return;var cols=['var(--accent-1)','var(--accent-2)','var(--accent-3)','var(--accent-4)'];var h='';cfg.goals.forEach(function(g,i){var v='--',l=g.name;if(g.deadline){var df=Math.ceil((new Date(g.deadline)-new Date())/(1000*60*60*24));v=df>0?df:0;l='Days to '+g.name;}h+='<div class="countdown-card" style="border-color:'+cols[i%4]+';"><div class="countdown-number">'+g.emoji+' '+v+'</div><div class="countdown-label">'+l+'</div></div>';});c.innerHTML=h;}
function renderLegend(){var c=document.getElementById('legend');if(!cfg||!cfg.categories)return;var cols=['var(--accent-1)','var(--accent-2)','var(--accent-3)','var(--accent-4)','var(--accent-5)'];var h='';cfg.categories.forEach(function(x,i){h+='<div class="legend-item"><div class="legend-dot" style="background:'+cols[i%5]+';"></div>'+x.emoji+' '+x.name+'</div>';});c.innerHTML=h;}

function renderToday(){
    var c=document.getElementById('todayTasks'),k=todayKey(),dn=dayName(),tpl=(cfg&&cfg.template)?cfg.template[dn]||[]:[],dd=getDayData(k);
    var all=[];
    tpl.forEach(function(t,i){var tid=dn+'_'+i,s=dd.tplStatus[tid]||{on:false,done:false};all.push({id:tid,title:t.title,time:t.time,cat:t.cat,isTpl:true,on:s.on,done:s.done});});
    dd.custom.forEach(function(t){all.push({id:t.id,title:t.title,time:t.time,cat:t.cat,isTpl:false,on:true,done:t.done});});
    all.sort(function(a,b){return a.time.localeCompare(b.time);});
    if(all.length===0){c.innerHTML='<div class="empty-state">No tasks yet. Click "+ Load Template" or "+ Add Task"</div>';}
    else{var h='';all.forEach(function(t){var cl='task-item '+catClass(t.cat);if(t.done)cl+=' completed';if(t.isTpl&&!t.on)cl+=' template';h+='<div class="'+cl+'" data-id="'+t.id+'" data-tpl="'+t.isTpl+'"><div class="task-checkbox"><span class="task-checkbox-inner">‚úì</span></div><div class="task-content"><div class="task-title">'+t.title+'</div><div class="task-meta">'+fmtTime(t.time)+'</div></div>'+(!t.isTpl?'<button class="task-delete" data-id="'+t.id+'">√ó</button>':'')+'</div>';});c.innerHTML=h;}
    updateStats(all);renderSuggestions(tpl,dd);
}
function updateStats(all){var act=all.filter(function(t){return t.on||!t.isTpl;}),dn=act.filter(function(t){return t.done;}).length;document.getElementById('doneCount').textContent=dn;document.getElementById('leftCount').textContent=act.length-dn;document.getElementById('dayProgress').style.width=act.length?(dn/act.length*100)+'%':'0%';}
function renderSuggestions(tpl,dd){var c=document.getElementById('suggestions'),dn=dayName(),not=tpl.filter(function(t,i){var s=dd.tplStatus[dn+'_'+i];return!s||!s.on;});if(not.length===0){c.innerHTML='<div style="color:var(--text-muted);font-size:0.8rem;">All template tasks loaded!</div>';}else{var h='';not.forEach(function(t,i){var idx=tpl.indexOf(t);h+='<div class="mini-sug '+catClass(t.cat)+'" data-tid="'+dn+'_'+idx+'"><span>'+t.title+'</span><span style="color:var(--text-muted);">'+fmtTime(t.time)+'</span></div>';});c.innerHTML=h;}}

function renderWeek(){
    var c=document.getElementById('weekGrid'),days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],today=new Date(),tdn=dayName();
    var mon=new Date(today);var dow=today.getDay();mon.setDate(today.getDate()-(dow===0?6:dow-1));
    var h='';days.forEach(function(day,i){
        var d=new Date(mon);d.setDate(mon.getDate()+i);var dk=d.toISOString().split('T')[0],ds=d.toLocaleDateString('en-US',{month:'short',day:'numeric'}),isT=day===tdn;
        var tpl=(cfg&&cfg.template)?cfg.template[day]||[]:[],dd=getDayData(dk);
        var act=0,dn=0;tpl.forEach(function(t,ti){var s=dd.tplStatus[day+'_'+ti];if(s&&s.on){act++;if(s.done)dn++;}});dd.custom.forEach(function(t){act++;if(t.done)dn++;});
        var pr=act?(dn/act*100):0;
        h+='<div class="day-column '+(isT?'today':'')+'" data-date="'+dk+'" data-day="'+day+'"><div class="day-header"><div class="day-name">'+day+'</div><div class="day-date">'+ds+'</div><div class="day-progress"><div class="day-progress-fill" style="width:'+pr+'%;"></div></div></div>';
        tpl.forEach(function(t,ti){var tid=day+'_'+ti,s=dd.tplStatus[tid]||{on:false,done:false},cl='week-task '+catClass(t.cat);if(!s.on)cl+=' template';if(s.done)cl+=' completed';h+='<div class="'+cl+'" data-date="'+dk+'" data-day="'+day+'" data-id="'+tid+'" data-tpl="true">'+t.title+'<div class="week-task-time">'+fmtTime(t.time)+'</div></div>';});
        dd.custom.forEach(function(t){var cl='week-task '+catClass(t.cat);if(t.done)cl+=' completed';h+='<div class="'+cl+'" data-date="'+dk+'" data-id="'+t.id+'" data-tpl="false">'+t.title+'<div class="week-task-time">'+fmtTime(t.time)+'</div></div>';});
        h+='</div>';
    });c.innerHTML=h;
}

function renderGoals(){var c=document.getElementById('goalsGrid');if(!cfg||!cfg.goals)return;var cols=['var(--accent-1)','var(--accent-2)','var(--accent-3)','var(--accent-4)'];var h='';cfg.goals.forEach(function(g,i){var days='--',pr=0;if(g.deadline){var df=Math.ceil((new Date(g.deadline)-new Date())/(1000*60*60*24));days=df>0?df+' days left':'Past deadline!';pr=Math.max(0,Math.min(100,100-(df/90*100)));}h+='<div class="card goal-card"><div class="goal-header"><span class="goal-title">'+g.emoji+' '+g.name+'</span><span class="goal-deadline">'+(g.deadline||'No deadline')+'</span></div><div class="progress-bar"><div class="progress-fill" style="width:'+pr+'%;background:'+cols[i%4]+';"></div></div><div style="font-size:0.8rem;color:var(--text-muted);">'+days+'</div></div>';});c.innerHTML=h;}

function toggle(id,isTpl,dk,dn){pushUndo();var dd=getDayData(dk||todayKey());if(isTpl==='true'||isTpl===true){if(!dd.tplStatus[id])dd.tplStatus[id]={on:false,done:false};if(!dd.tplStatus[id].on){dd.tplStatus[id].on=true;}else{dd.tplStatus[id].done=!dd.tplStatus[id].done;}}else{var t=dd.custom.find(function(x){return x.id===id;});if(t)t.done=!t.done;}saveData();renderToday();renderWeek();}
function loadAllTpl(){pushUndo();var k=todayKey(),dn=dayName(),tpl=(cfg&&cfg.template)?cfg.template[dn]||[]:[],dd=getDayData(k);tpl.forEach(function(t,i){var tid=dn+'_'+i;if(!dd.tplStatus[tid])dd.tplStatus[tid]={on:false,done:false};dd.tplStatus[tid].on=true;});saveData();renderToday();renderWeek();}
function delTask(id){pushUndo();var dd=getDayData(todayKey());dd.custom=dd.custom.filter(function(t){return t.id!==id;});saveData();renderToday();}
function undoAction(){if(undo.length===0)return alert('Nothing to undo');data=JSON.parse(undo.pop());saveData();renderToday();renderWeek();}
function endDay(){var k=todayKey(),dn=dayName(),tpl=(cfg&&cfg.template)?cfg.template[dn]||[]:[],dd=getDayData(k),act=0,done=0;tpl.forEach(function(t,i){var s=dd.tplStatus[dn+'_'+i];if(s&&s.on){act++;if(s.done)done++;}});dd.custom.forEach(function(t){act++;if(t.done)done++;});if(act===0)alert('No tasks activated!');else if(done===act)alert('üéâ Amazing! All '+done+' tasks done!');else alert('Day ended: '+done+'/'+act+' completed.');}

function showView(v){document.querySelectorAll('.view').forEach(function(x){x.classList.remove('active');});document.querySelectorAll('.nav-btn').forEach(function(x){x.classList.remove('active');});document.getElementById(v+'View').classList.add('active');document.getElementById('btn'+v.charAt(0).toUpperCase()+v.slice(1)).classList.add('active');}
function openTaskModal(){var s=document.getElementById('taskCat');s.innerHTML='';(cfg.categories||[]).forEach(function(c){s.innerHTML+='<option value="'+c.id+'">'+c.emoji+' '+c.name+'</option>';});document.getElementById('taskName').value='';document.getElementById('taskTime').value='09:00';document.getElementById('taskModal').classList.add('active');}
function closeTaskModal(){document.getElementById('taskModal').classList.remove('active');}
function saveTask(){var n=document.getElementById('taskName').value.trim();if(!n)return alert('Enter a task name');pushUndo();var dd=getDayData(todayKey());dd.custom.push({id:genId(),title:n,cat:document.getElementById('taskCat').value,time:document.getElementById('taskTime').value,done:false});saveData();closeTaskModal();renderToday();renderWeek();}
function closeSettings(){document.getElementById('settingsModal').classList.remove('active');}
function editSetup(){closeSettings();step=2;document.getElementById('setupModal').classList.add('active');renderStep();}
function exportData(){var e={cfg:cfg,data:data},b=new Blob([JSON.stringify(e,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='life-dashboard-backup.json';a.click();}
function importData(){var inp=document.createElement('input');inp.type='file';inp.accept='.json';inp.onchange=function(e){var f=e.target.files[0],r=new FileReader();r.onload=function(ev){try{var im=JSON.parse(ev.target.result);if(im.cfg){cfg=im.cfg;saveCfg();}if(im.data){data=im.data;saveData();}closeSettings();renderAll();alert('Imported!');}catch(err){alert('Invalid file');}};r.readAsText(f);};inp.click();}
function resetAll(){if(confirm('Delete ALL data?')){localStorage.removeItem(CFG_KEY);localStorage.removeItem(DATA_KEY);location.reload();}}

function setupEvents(){
    document.getElementById('btnToday').addEventListener('click',function(){showView('today');});
    document.getElementById('btnWeek').addEventListener('click',function(){showView('week');});
    document.getElementById('btnGoals').addEventListener('click',function(){showView('goals');});
    document.getElementById('btnAddTask').addEventListener('click',openTaskModal);
    document.getElementById('btnLoadTpl').addEventListener('click',loadAllTpl);
    document.getElementById('btnUndo').addEventListener('click',undoAction);
    document.getElementById('btnEndDay').addEventListener('click',endDay);
    document.getElementById('btnSettings').addEventListener('click',function(){document.getElementById('settingsModal').classList.add('active');});
    document.getElementById('todayTasks').addEventListener('click',function(e){var it=e.target.closest('.task-item'),dl=e.target.closest('.task-delete');if(dl){if(confirm('Delete?'))delTask(dl.dataset.id);}else if(it){toggle(it.dataset.id,it.dataset.tpl);}});
    document.getElementById('suggestions').addEventListener('click',function(e){var s=e.target.closest('.mini-sug');if(s){pushUndo();var tid=s.dataset.tid,dd=getDayData(todayKey());if(!dd.tplStatus[tid])dd.tplStatus[tid]={on:false,done:false};dd.tplStatus[tid].on=true;saveData();renderToday();renderWeek();}});
    document.getElementById('weekGrid').addEventListener('click',function(e){var t=e.target.closest('.week-task');if(t){toggle(t.dataset.id,t.dataset.tpl,t.dataset.date,t.dataset.day);}});
    document.getElementById('taskModal').addEventListener('click',function(e){if(e.target===this)closeTaskModal();});
    document.getElementById('settingsModal').addEventListener('click',function(e){if(e.target===this)closeSettings();});
}
init();
</script>
</body>
</html>
